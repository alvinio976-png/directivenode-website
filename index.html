<!DOCTYPE html>
<html lang="fr">
<head>
    <title>directivenode</title>
    <meta charset="UTF-8">
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #top-bar { background: #f0f0f0; padding: 10px; display: flex; gap: 10px; align-items: center; }
        #add-toolbar { background: #e0e0e0; padding: 10px; display: flex; gap: 10px; }
        #tip { padding: 5px; font-size: 12px; color: #666; }
        #board { position: relative; width: 100vw; height: calc(100vh - 100px); overflow: hidden; background: #ffffff; transform-origin: top left; }
        .item { position: absolute; border: 1px solid #ccc; padding: 10px; background: #fff; min-width: 100px; min-height: 50px; cursor: move; resize: both; overflow: auto; }
        #login-panel { position: fixed; top: 20%; left: 40%; background: #fff; padding: 20px; border: 1px solid #000; z-index: 1000; display: none; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        #projects-panel { position: fixed; top: 20%; left: 40%; background: #fff; padding: 20px; border: 1px solid #000; z-index: 1000; display: none; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        #users-panel { position: fixed; top: 20%; left: 40%; background: #fff; padding: 20px; border: 1px solid #000; z-index: 1000; display: none; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        button, span { cursor: pointer; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-storage.js"></script>
</head>
<body>
    <div id="top-bar">
        <span>directivenode</span>
        <span id="projects-btn">Projets ▾</span>
        <span id="fit-btn">Fit (Z)</span>
        <span id="connect-btn">Connect</span>
        <span id="utilisateurs-btn">Utilisateurs</span>
        <span>Read-only: OFF</span>
        <span>Présentation</span>
        <span id="exporter-btn">Exporter</span>
        <span id="importer-btn">Importer</span>
        <span id="logout-btn" style="display: none;">Logout</span>
    </div>
    <div id="add-toolbar">
        <span class="add-btn" data-type="note">📝 Note</span>
        <span class="add-btn" data-type="document">📄 Document</span>
        <span class="add-btn" data-type="todo">☑️ To-do</span>
        <span class="add-btn" data-type="image">🖼️ Image</span>
        <span class="add-btn" data-type="lien">🔗 Lien</span>
        <span class="add-btn" data-type="couleur">🎨 Couleur</span>
        <span class="add-btn" data-type="colonne">📦 Colonne</span>
        <span class="add-btn" data-type="tableau">📊 Tableau</span>
        <span class="add-btn" data-type="carte">🗺️ Carte</span>
    </div>
    <div id="tip">Espace+glisser: pan • Ctrl/Cmd ±: zoom • “/”: Quick add • Alt+glisser: dupliquer • clic droit: menu</div>
    <div id="board"></div>
    <div id="login-panel">
        <div>directivenode</div>
        <div>Workboards visuels sécurisés</div>
        <input type="text" id="user-input" placeholder="Utilisateur">
        <input type="password" id="pass-input" placeholder="Mot de passe">
        <button id="login-btn">Se connecter</button>
        <span>Besoin d'aide ?</span>
        <div>Astuce Si tu as un souci de connexion, clique Réparer admin pour recréer le compte administrateur par défaut.</div>
        <button id="repair-admin">Réparer admin</button>
        <button id="reset-accounts">Réinitialiser comptes</button>
        <div>Identifiants stockés sur Firebase (sécurisés).</div>
    </div>
    <div id="projects-panel">
        <div>Projets de <span id="current-user"></span></div>
        <div id="projects-list"></div>
        <button id="create-project">Créer</button>
        <button id="close-projects">Fermer</button>
    </div>
    <div id="users-panel">
        <div>Comptes utilisateur</div>
        <div id="users-list"></div>
        <button id="add-user">Ajouter</button>
        <button id="close-users">Fermer</button>
        <div>Règles : au moins 1 admin doit exister. Impossible de supprimer le dernier admin ou votre propre compte connecté.</div>
    </div>
    <script>
        // Remplacez par votre configuration Firebase réelle
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(app);
        const db = firebase.firestore(app);
        const storage = firebase.storage(app); // Non utilisé ici, mais disponible si besoin

        // État global
        let currentUser = null;
        let currentProjectId = null;
        let scale = 1;
        let translateX = 0;
        let translateY = 0;
        let items = [];
        let projectName = ''; // Pour stocker le nom du projet lors de l'export

        // Surveillance de l'état d'authentification
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('login-panel').style.display = 'none';
                document.getElementById('connect-btn').style.display = 'none';
                document.getElementById('logout-btn').style.display = 'inline';
                document.getElementById('current-user').innerText = user.email;
                loadProjects();
            } else {
                currentUser = null;
                document.getElementById('login-panel').style.display = 'block';
                document.getElementById('connect-btn').style.display = 'inline';
                document.getElementById('logout-btn').style.display = 'none';
                document.getElementById('board').innerHTML = '';
                items = [];
            }
        });

        // Connexion
        document.getElementById('login-btn').addEventListener('click', () => {
            const username = document.getElementById('user-input').value;
            const password = document.getElementById('pass-input').value;
            const email = `${username}@directivenode.com`; // Conversion username en email
            auth.signInWithEmailAndPassword(email, password).catch(error => alert(error.message));
        });

        // Déconnexion
        document.getElementById('logout-btn').addEventListener('click', () => {
            auth.signOut();
        });

        // Bouton Connect affiche le panel login
        document.getElementById('connect-btn').addEventListener('click', () => {
            document.getElementById('login-panel').style.display = 'block';
        });

        // Réparer admin
        document.getElementById('repair-admin').addEventListener('click', () => {
            const email = 'admin@directivenode.com';
            const password = 'admin123'; // Changez ce mot de passe par défaut pour la sécurité
            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    db.collection('users').doc(userCredential.user.uid).set({ email, isAdmin: true });
                    alert('Compte admin créé ou réparé.');
                })
                .catch(error => {
                    if (error.code === 'auth/email-already-in-use') {
                        alert('Le compte admin existe déjà.');
                    } else {
                        alert(error.message);
                    }
                });
        });

        // Réinitialiser comptes (simulé, car suppression massive non sécurisée en client)
        document.getElementById('reset-accounts').addEventListener('click', () => {
            if (confirm('Voulez-vous vraiment réinitialiser tous les comptes ? Cela n\'est pas implémenté pour des raisons de sécurité.')) {
                alert('Fonctionnalité non disponible en client-side pour éviter les abus. Utilisez l\'Admin SDK Firebase.');
            }
        });

        // Afficher panel utilisateurs
        document.getElementById('utilisateurs-btn').addEventListener('click', () => {
            if (currentUser) {
                document.getElementById('users-panel').style.display = 'block';
                loadUsers();
            } else {
                alert('Veuillez vous connecter.');
            }
        });

        // Charger utilisateurs
        function loadUsers() {
            db.collection('users').get().then(snapshot => {
                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    html += `<div>${data.email} - ${data.isAdmin ? 'Admin' : 'User'}</div>`;
                });
                document.getElementById('users-list').innerHTML = html;
            }).catch(error => console.error(error));
        }

        // Ajouter utilisateur
        document.getElementById('add-user').addEventListener('click', () => {
            const username = prompt('Utilisateur:');
            const password = prompt('Mot de passe:');
            const isAdmin = confirm('Est-ce un admin ?');
            if (username && password) {
                const email = `${username}@directivenode.com`;
                auth.createUserWithEmailAndPassword(email, password)
                    .then(userCredential => {
                        db.collection('users').doc(userCredential.user.uid).set({ email, isAdmin });
                        loadUsers();
                    })
                    .catch(error => alert(error.message));
            }
        });

        // Afficher panel projets
        document.getElementById('projects-btn').addEventListener('click', () => {
            if (currentUser) {
                document.getElementById('projects-panel').style.display = 'block';
                loadProjects();
            } else {
                alert('Veuillez vous connecter.');
            }
        });

        // Charger projets
        function loadProjects() {
            db.collection('projects').where('owner', '==', currentUser.uid).get().then(snapshot => {
                let html = '';
                snapshot.forEach(doc => {
                    html += `<div class="project-item" data-id="${doc.id}">${doc.data().name}</div>`;
                });
                document.getElementById('projects-list').innerHTML = html;
                document.querySelectorAll('.project-item').forEach(item => {
                    item.addEventListener('click', () => {
                        currentProjectId = item.dataset.id;
                        db.collection('projects').doc(currentProjectId).get().then(doc => {
                            projectName = doc.data().name;
                        });
                        loadProject();
                        document.getElementById('projects-panel').style.display = 'none';
                    });
                });
            }).catch(error => console.error(error));
        }

        // Créer projet
        document.getElementById('create-project').addEventListener('click', () => {
            const name = prompt('Nom du projet:');
            if (name) {
                db.collection('projects').add({ name, owner: currentUser.uid, items: [] }).then(() => loadProjects());
            }
        });

        // Charger projet
        function loadProject() {
            db.collection('projects').doc(currentProjectId).get().then(doc => {
                if (doc.exists) {
                    items = doc.data().items || [];
                    renderBoard();
                }
            }).catch(error => console.error(error));
        }

        // Rendre le board
        function renderBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            items.forEach(item => {
                const el = document.createElement('div');
                el.className = 'item';
                el.style.left = `${item.left}px`;
                el.style.top = `${item.top}px`;
                el.style.width = `${item.width}px`;
                el.style.height = `${item.height}px`;
                el.innerHTML = `<div contenteditable="true">${item.content}</div>`;
                el.dataset.id = item.id;
                el.dataset.type = item.type;
                makeDraggable(el);
                board.appendChild(el);
            });
            updateTransform();
        }

        // Rendre draggable
        function makeDraggable(el) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            el.onmousedown = dragMouseDown;
            function dragMouseDown(e) {
                e.preventDefault();
                if (e.altKey) {
                    const newItem = cloneItem(el);
                    items.push(newItem);
                    saveProject();
                    renderBoard();
                    return;
                }
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }
            function elementDrag(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                el.style.top = (el.offsetTop - pos2) + 'px';
                el.style.left = (el.offsetLeft - pos1) + 'px';
            }
            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
                const id = el.dataset.id;
                const item = items.find(i => i.id === id);
                if (item) {
                    item.top = parseInt(el.style.top);
                    item.left = parseInt(el.style.left);
                    item.width = el.offsetWidth;
                    item.height = el.offsetHeight;
                    saveProject();
                }
            }
        }

        // Cloner item
        function cloneItem(el) {
            const oldItem = items.find(i => i.id === el.dataset.id);
            return { ...oldItem, id: Date.now().toString(), left: oldItem.left + 20, top: oldItem.top + 20 };
        }

        // Ajouter items
        document.querySelectorAll('.add-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (!currentProjectId) return alert('Sélectionnez ou créez un projet.');
                const type = btn.dataset.type;
                const id = Date.now().toString();
                const newItem = { id, type, left: 100, top: 100, width: 200, height: 100, content: `Nouveau ${type}` };
                items.push(newItem);
                renderBoard();
                saveProject();
            });
        });

        // Sauvegarder projet
        function saveProject() {
            if (currentProjectId) {
                db.collection('projects').doc(currentProjectId).update({ items }).catch(error => console.error(error));
            }
        }

        // Pan
        const board = document.getElementById('board');
        let isPanning = false;
        let startX = 0, startY = 0;
        board.addEventListener('mousedown', e => {
            if (e.button === 0 && e.target === board) {
                isPanning = true;
                startX = e.clientX - translateX;
                startY = e.clientY - translateY;
                board.style.cursor = 'grabbing';
            }
        });
        board.addEventListener('mousemove', e => {
            if (isPanning) {
                translateX = e.clientX - startX;
                translateY = e.clientY - startY;
                updateTransform();
            }
        });
        board.addEventListener('mouseup', () => { isPanning = false; board.style.cursor = 'default'; });
        board.addEventListener('mouseleave', () => { isPanning = false; });

        // Zoom
        board.addEventListener('wheel', e => {
            e.preventDefault();
            const delta = e.deltaY * -0.001;
            const newScale = Math.max(0.1, Math.min(10, scale + delta));
            const rect = board.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            translateX = mouseX - (mouseX - translateX) * (newScale / scale);
            translateY = mouseY - (mouseY - translateY) * (newScale / scale);
            scale = newScale;
            updateTransform();
        });

        // Mettre à jour transform
        function updateTransform() {
            board.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
        }

        // Fit
        document.getElementById('fit-btn').addEventListener('click', () => {
            scale = 1;
            translateX = 0;
            translateY = 0;
            updateTransform();
        });

        // Exporter JSON
        document.getElementById('exporter-btn').addEventListener('click', () => {
            if (!currentProjectId) return alert('Sélectionnez un projet.');
            const data = JSON.stringify({ name: projectName, items });
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${projectName || 'project'}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // Importer JSON
        document.getElementById('importer-btn').addEventListener('click', () => {
            if (!currentUser) return alert('Veuillez vous connecter.');
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = event => {
                        try {
                            const data = JSON.parse(event.target.result);
                            db.collection('projects').add({
                                name: data.name || 'Projet importé',
                                owner: currentUser.uid,
                                items: data.items || []
                            }).then(() => {
                                loadProjects();
                                alert('Projet importé avec succès.');
                            }).catch(error => alert('Erreur lors de l\'import: ' + error.message));
                        } catch (error) {
                            alert('Fichier JSON invalide.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        });

        // Sauvegarde du contenu éditable
        board.addEventListener('input', e => {
            if (e.target.contentEditable === 'true') {
                const el = e.target.closest('.item');
                if (el) {
                    const id = el.dataset.id;
                    const item = items.find(i => i.id === id);
                    if (item) {
                        item.content = e.target.innerHTML;
                        saveProject();
                    }
                }
            }
        });

        // Menu clic droit (simulé)
        board.addEventListener('contextmenu', e => {
            e.preventDefault();
            if (e.target.closest('.item')) {
                alert('Menu: 🔒 Verrouiller / Déverrouiller ⧉ Dupliquer ➡️ Déplacer vers colonne… ⬅️ Sortir de la colonne 💬 Commentaires 🗑️ Supprimer');
                // Implémentez les actions ici si nécessaire
            }
        });

        // Fermer panels
        document.getElementById('close-projects').addEventListener('click', () => {
            document.getElementById('projects-panel').style.display = 'none';
        });
        document.getElementById('close-users').addEventListener('click', () => {
            document.getElementById('users-panel').style.display = 'none';
        });
    </script>
</body>
</html>