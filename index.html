<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>directivenode ‚Äî Boards</title>
<style>
:root{--bg:#F5F6F7;--panel:#fff;--ink:#0f172a;--muted:#667085;--line:#e5e7eb;--accent:#3b82f6;--accent-weak:#dbeafe;--radius:12px;--grid:8px;--shadow:0 12px 32px rgba(2,6,23,.12);--locked:#fde68a;--danger:#ef4444;--brand:#111827}
*{box-sizing:border-box}html,body{height:100%;margin:0;font:14px/1.45 ui-sans-serif,-apple-system,Segoe UI,Roboto,Helvetica,Arial}body{background:var(--bg);color:var(--ink);overflow:hidden}
/* hide app until login */
body.authing #topbar,body.authing #sidebar,body.authing #viewport,body.authing #projectsModal,body.authing #usersModal,body.authing #ctx{display:none!important;visibility:hidden!important}
/* topbar */
.topbar{position:fixed;inset:0 0 auto 0;height:58px;display:flex;align-items:center;gap:10px;background:var(--panel);border-bottom:1px solid var(--line);padding:0 12px;z-index:6;box-shadow:var(--shadow)}
.brand{display:flex;align-items:center;gap:8px;font-weight:800;color:var(--brand)}.brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 4px var(--accent-weak)}
.title{border:none;background:#f8fafc;padding:8px 10px;border-radius:10px;width:280px}.sep{width:1px;height:28px;background:var(--line)}
.input{border:1px solid var(--line);border-radius:10px;background:#f8fafc;padding:6px 10px;display:flex;align-items:center;gap:8px;min-width:280px}
.input input{border:none;background:transparent;outline:none;width:100%}
.btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}.btn.primary{background:var(--accent);color:#fff;border-color:transparent}.btn.danger{background:var(--danger);color:#fff;border-color:transparent}.btn.ghost{background:transparent}.btn:disabled{opacity:.6;cursor:not-allowed}.right{margin-left:auto;display:flex;gap:8px;align-items:center}
/* sidebar */
.sidebar{position:fixed;left:12px;top:72px;bottom:12px;width:230px;background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:var(--shadow);z-index:3;overflow:auto}
.tool{display:flex;align-items:center;gap:8px;border:1px dashed var(--line);padding:8px;border-radius:10px;cursor:grab;margin-bottom:8px;background:#fafafa}.tool:hover{border-style:solid}
/* viewport/canvas */
.viewport{position:absolute;inset:58px 0 0 0}.canvas-wrap{position:absolute;inset:0;overflow:hidden}
.canvas{position:absolute;left:0;top:0;width:8000px;height:8000px;background-image:radial-gradient(rgba(16,24,40,.05) 1px, transparent 0);background-size:var(--grid) var(--grid);transform-origin:0 0;border:2px solid #cbd5e1;border-radius:4px;box-shadow:inset 0 0 0 1px rgba(2,6,23,.04)}
.hint{position:fixed;left:254px;top:76px;font-size:12px;color:var(--muted);background:#fff;border:1px solid var(--line);padding:6px 10px;border-radius:8px;box-shadow:var(--shadow);z-index:4}
/* cards */
.card{position:absolute;min-width:168px;min-height:96px;background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);user-select:none}
.card.locked{outline:2px dashed var(--locked);outline-offset:2px}.card-header{height:34px;background:#fbfbfb;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;padding:0 8px;border-radius:12px 12px 0 0;cursor:grab}
.card-title{font-weight:600}.card-actions{display:flex;gap:6px}.card-actions button{border:1px solid var(--line);background:#fff;border-radius:8px;padding:4px 6px;cursor:pointer}
.content{padding:10px;overflow:auto;height:calc(100% - 34px);border-radius:0 0 12px 12px}.resizer{position:absolute;right:-6px;bottom:-6px;width:14px;height:14px;background:#fff;border:1px solid var(--line);border-radius:4px;cursor:nwse-resize}
/* types */
.note .content[contenteditable="true"]{outline:none;white-space:pre-wrap}.doc .toolbar{display:flex;gap:6px;margin-bottom:6px}.doc .toolbar button{border:1px solid var(--line);background:#fff;border-radius:8px;padding:4px 8px;cursor:pointer}.doc .editor{min-height:120px;padding:8px;border:1px solid var(--line);border-radius:8px;outline:none}
.todo ul{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px}.todo li{display:flex;gap:8px;align-items:center}
.image .content img{max-width:100%;display:block;border-radius:10px;margin-bottom:8px}.swatch .content{display:flex;gap:10px;align-items:center}.swatch .chip{width:28px;height:28px;border-radius:6px;border:1px solid var(--line)}.link .meta{color:var(--muted);font-size:12px}
/* column */
.column{background:#fcfcfc}.column .content{display:flex;flex-direction:column;gap:8px;min-height:120px}.column .dropzone{border:1px dashed var(--line);border-radius:10px;padding:8px;text-align:center;color:var(--muted)}
.child{position:relative;background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px;box-shadow:none}.child .child-actions{position:absolute;top:6px;right:6px;display:flex;gap:6px}.child .child-actions button{border:1px solid var(--line);background:#fff;border-radius:8px;padding:2px 6px;cursor:pointer}
/* table */
.table .content{overflow:auto}.table table{border-collapse:collapse;width:100%}.table th,.table td{border:1px solid var(--line);padding:6px;min-width:80px}.table tfoot td{background:#f8fafc;font-weight:600}
/* read-only/presentation */
.readonly .card-header{cursor:default}.readonly .resizer,.readonly .tool,.readonly .card-actions .edit-only{display:none}.present *:not(.canvas,.canvas *){display:none!important}.present .canvas{background:#fff}
/* context menu */
.ctx{position:absolute;background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:var(--shadow);padding:6px;display:none;z-index:10}.ctx button{display:block;width:100%;text-align:left;border:none;background:#fff;padding:8px;border-radius:8px;cursor:pointer}.ctx button:hover{background:#f8fafc}
/* connectors SVG */
svg.wires{position:absolute;left:0;top:0;pointer-events:none;transform-origin:0 0}
/* auth overlay */
.overlay{position:fixed;inset:0;background:radial-gradient(1200px 600px at 10% -20%, rgba(59,130,246,.18), transparent), linear-gradient(180deg, rgba(2,6,23,.22), rgba(2,6,23,.06));display:flex;align-items:center;justify-content:center;z-index:9999;pointer-events:auto}
.card-auth{width:min(520px, 92vw);background:#fff;border:1px solid var(--line);border-radius:20px;box-shadow:var(--shadow);padding:20px}
.hero{display:flex;gap:10px;align-items:center;margin-bottom:10px}.logo{width:40px;height:40px;border-radius:12px;background:conic-gradient(from 120deg, var(--accent), #22c55e, #a855f7, var(--accent));box-shadow:0 6px 18px rgba(2,6,23,.2)}.hero h1{margin:0;font-size:22px}.hero small{color:var(--muted);display:block}
.field{margin:8px 0}.field input{width:100%;padding:12px;border:1px solid var(--line);border-radius:10px}.note{font-size:12px;color:var(--muted)}.actions{display:flex;gap:8px;margin-top:8px}
.banner{display:flex;gap:8px;padding:10px;border:1px dashed var(--line);border-radius:12px;background:#fafafa;margin-top:8px;color:#334155;align-items:center;justify-content:space-between}.banner .row{display:flex;gap:8px;align-items:center}.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--accent-weak);color:var(--accent);font-weight:700;font-size:12px}
/* modals */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,23,42,.28);backdrop-filter:saturate(120%) blur(2px);z-index:9998;pointer-events:auto}
.modal .window{width:min(720px,92vw);max-height:80vh;overflow:auto;background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:16px}
.modal h3{margin:0 0 8px 0}.modal .list .item{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;background:#fafafa;border:1px solid var(--line);border-radius:12px;padding:10px;margin-bottom:8px}.modal .list .name{flex:1}.modal .list .actions{display:flex;gap:8px;flex-wrap:wrap}
</style>
</head>
<body class="authing">
  <div class="topbar" id="topbar" style="display:none">
    <div class="brand"><span class="dot"></span> directivenode</div>
    <button class="btn" id="projectsBtn">Projets ‚ñæ</button>
    <input id="boardTitle" class="title" value="Projet D√©mo"/>
    <div class="sep"></div>
    <div class="input">
      <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><path d="M21 21l-4.35-4.35m2.1-5.4a7.5 7.5 0 11-15 0 7.5 7.5 0 0115 0z" fill="none" stroke="currentColor" stroke-width="2"/></svg>
      <input id="search" placeholder="Rechercher dans les cartes (Ctrl/Cmd+F)"/>
    </div>
    <button class="btn" id="fitBtn">Fit (Z)</button>
    <button class="btn" id="connectBtn">Connect</button>
    <div class="right">
      <button class="btn" id="usersBtn" style="display:none">Utilisateurs</button>
      <button class="btn" id="readonlyBtn">Read-only: OFF</button>
      <button class="btn" id="presentBtn">Pr√©sentation</button>
      <button class="btn" id="exportBtn">Exporter</button>
      <label class="btn" for="importInput">Importer</label><input id="importInput" type="file" accept="application/json" style="display:none"/>
      <button class="btn danger" id="logoutBtn" title="Se d√©connecter">Logout</button>
    </div>
  </div>

  <aside class="sidebar" id="sidebar" style="display:none">
    <div class="tool" data-type="note" draggable="true">üìù Note</div>
    <div class="tool" data-type="doc" draggable="true">üìÑ Document</div>
    <div class="tool" data-type="todo" draggable="true">‚òëÔ∏è To-do</div>
    <div class="tool" data-type="image" draggable="true">üñºÔ∏è Image</div>
    <div class="tool" data-type="link" draggable="true">üîó Lien</div>
    <div class="tool" data-type="swatch" draggable="true">üé® Couleur</div>
    <div class="tool" data-type="column" draggable="true">üì¶ Colonne</div>
    <div class="tool" data-type="table" draggable="true">üìä Tableau</div>
    <div class="tool" data-type="map" draggable="true">üó∫Ô∏è Carte</div>
    <div class="hint">Espace+glisser: pan ‚Ä¢ Ctrl/Cmd ¬±: zoom ‚Ä¢ ‚Äú/‚Äù: Quick add ‚Ä¢ Alt+glisser: dupliquer ‚Ä¢ clic droit: menu</div>
  </aside>

  <div class="viewport" id="viewport" style="display:none">
    <div class="canvas-wrap" id="wrap">
      <svg class="wires" id="wires" width="8000" height="8000"></svg>
      <div class="canvas" id="canvas" tabindex="0" role="application"></div>
    </div>
  </div>

  <div class="ctx" id="ctx">
    <button data-act="lock">üîí Verrouiller / D√©verrouiller</button>
    <button data-act="dup">‚ßâ Dupliquer</button>
    <button data-act="movecol">‚û°Ô∏è D√©placer vers colonne‚Ä¶</button>
    <button data-act="detach">‚¨ÖÔ∏è Sortir de la colonne</button>
    <button data-act="comment">üí¨ Commentaires</button>
    <button data-act="del">üóëÔ∏è Supprimer</button>
  </div>

  <!-- AUTH OVERLAY -->
  <div class="overlay" id="auth">
    <div class="card-auth">
      <div class="hero">
        <div class="logo"></div>
        <div><h1>directivenode</h1><small>Workboards visuels s√©curis√©s</small></div>
      </div>
      <div id="loginForm" class="login">
        <div class="field"><input id="liUser" placeholder="Nom d'utilisateur"></div>
        <div class="field"><input id="liPass" type="password" placeholder="Mot de passe"></div>
        <div class="actions">
          <button class="btn primary" id="loginBtn">Se connecter</button>
          <button class="btn ghost" id="showHintBtn">Besoin d'aide ?</button>
        </div>
        <div class="banner" id="hint" style="display:none">
          <div class="row"><span class="badge">Astuce</span> Si tu as un souci de connexion, clique <strong>R√©parer admin</strong> pour recr√©er le compte administrateur par d√©faut.</div>
          <div class="row">
            <button class="btn" id="fixAdminBtn">R√©parer admin</button>
            <button class="btn danger" id="resetAuthBtn">R√©initialiser comptes</button>
          </div>
        </div>
        <div class="note">Identifiants stock√©s localement (hash√©s) dans votre navigateur.</div>
      </div>
    </div>
  </div>

  <!-- PROJECTS MODAL -->
  <div class="modal" id="projectsModal">
    <div class="window">
      <h3>Projets de <span id="userDisplay"></span></h3>
      <div class="actions" style="justify-content:space-between">
        <div style="display:flex;gap:8px;flex:1">
          <input id="newProjectName" placeholder="Nom du nouveau projet" style="flex:1;padding:8px;border:1px solid var(--line);border-radius:10px"/>
          <button class="btn primary" id="createProjectBtn">Cr√©er</button>
        </div>
        <button class="btn" id="closeProjectsBtn">Fermer</button>
      </div>
      <div class="list" id="projectsList" style="margin-top:8px"></div>
    </div>
  </div>

  <!-- USERS MODAL -->
  <div class="modal" id="usersModal">
    <div class="window">
      <h3>Comptes utilisateur</h3>
      <div class="actions" style="gap:12px;align-items:flex-end">
        <div style="flex:1"><div class="field"><input id="nuUser" placeholder="Nom d'utilisateur (unique)"></div></div>
        <div style="flex:1"><div class="field"><input id="nuPass" type="password" placeholder="Mot de passe"></div></div>
        <div><select id="nuRole" class="btn"><option value="user">User</option><option value="admin">Admin</option></select></div>
        <button class="btn primary" id="addUserBtn">Ajouter</button>
        <button class="btn" id="closeUsersBtn">Fermer</button>
      </div>
      <div class="list" id="usersList" style="margin-top:8px"></div>
      <div class="note" style="margin-top:8px">R√®gles : au moins 1 admin doit exister. Impossible de supprimer le dernier admin ou votre propre compte connect√©.</div>
    </div>
  </div>

<script>
/* ===== Helpers ===== */
const $=(s,el=document)=>el.querySelector(s), $$=(s,el=document)=>Array.from(el.querySelectorAll(s));
function escapeHtml(s){return (s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}
function normalizeHex(v){if(!v)return"#000000";if(!v.startsWith("#"))v="#"+v;if(v.length===4)v="#"+v[1]+v[1]+v[2]+v[2]+v[3]+v[3];return v.slice(0,7)}
function coerce(v){const n=Number(v);return isFinite(n)&&v.trim()!==""?n:v}
const idn=()=>Math.random().toString(36).slice(2,9), GRID=8, CANVAS=8000;
const cssPos=(x,y)=>`translate(${x}px,${y}px)`;

/* ===== Auth (localStorage) ===== */
const AUTH_KEY="milanote_auth_v2", OLD_AUTH_KEY="milanote_auth_v1", OLD_SINGLE_KEY="milanote_clone_fn_v2";
let CURRENT_USER=null, CURRENT_PROJECT=null;

async function sha256Hex(str){const enc=new TextEncoder().encode(str);const buf=await crypto.subtle.digest("SHA-256",enc);return [...new Uint8Array(buf)].map(x=>x.toString(16).padStart(2,"0")).join("")}
function randHex(n=16){const a=new Uint8Array(n);crypto.getRandomValues(a);return [...a].map(x=>x.toString(16).padStart(2,"0")).join("")}
function loadAuth(){const v2=localStorage.getItem(AUTH_KEY);if(v2) return JSON.parse(v2);const v1=localStorage.getItem(OLD_AUTH_KEY);if(v1){const j=JSON.parse(v1);if(j&&j.users){const users={};for(const [u,rec] of Object.entries(j.users)){users[u]={...rec,role:"admin"}}const v2obj={users, current:j.current||null};localStorage.setItem(AUTH_KEY,JSON.stringify(v2obj));return v2obj}}return {users:{}, current:null}}
function saveAuth(obj){localStorage.setItem(AUTH_KEY,JSON.stringify(obj))}
function isAdmin(u){const a=loadAuth();return !!(a.users[u]&&a.users[u].role==="admin")}
function findUserKeyCaseInsensitive(u){const a=loadAuth();const t=u.toLowerCase();for(const k of Object.keys(a.users)){if(k.toLowerCase()===t) return k}return null}

async function createOrResetAdmin(){const u="ALVINIO", p="Wsxcfrt123";const a=loadAuth();const salt=randHex(16);const hash=await sha256Hex(salt+p);a.users[u]={salt,hash,role:"admin"};a.current=null;saveAuth(a);alert("Admin par d√©faut recr√©√©.")}
async function ensureHardcodedAdmin(){const a=loadAuth();const exists=Object.keys(a.users).some(k=>k.toLowerCase()==="alvinio");if(!exists){const u="ALVINIO", p="Wsxcfrt123";const salt=randHex(16);const hash=await sha256Hex(salt+p);a.users[u]={salt,hash,role:"admin"};a.current=null;saveAuth(a)}}

async function initAuthUI(){
  await ensureHardcodedAdmin();
  document.body.classList.add("authing"); $("#auth").style.display="flex";
  $("#showHintBtn").onclick=()=>{$("#hint").style.display=$("#hint").style.display==="none"?"flex":"none"};
  $("#fixAdminBtn").onclick=async()=>{await createOrResetAdmin()};
  $("#resetAuthBtn").onclick=()=>{if(confirm("Effacer la liste des comptes ? (Les projets restent)")){localStorage.removeItem(AUTH_KEY);alert("Comptes r√©initialis√©s. Recharge la page.");location.reload()}};
  $("#loginBtn").onclick=async()=>{
    const u=$("#liUser").value.trim(), p=$("#liPass").value; const a=loadAuth(); const key=findUserKeyCaseInsensitive(u);
    if(!key){alert("Utilisateur introuvable");return}
    const rec=a.users[key]; const hash=await sha256Hex(rec.salt+p); if(hash!==rec.hash){alert("Mot de passe incorrect");return}
    a.current=key; saveAuth(a); CURRENT_USER=key; await firstOpenOrMigrate();
    $("#auth").style.display="none"; document.body.classList.remove("authing"); showApp();
  };
}
function logout(){const a=loadAuth();a.current=null;saveAuth(a);CURRENT_USER=null;CURRENT_PROJECT=null;hideApp();initAuthUI()}
function showApp(){ $("#topbar").style.display="flex"; $("#sidebar").style.display="block"; $("#viewport").style.display="block"; $("#userDisplay").textContent=CURRENT_USER||""; $("#usersBtn").style.display=isAdmin(CURRENT_USER)?"inline-block":"none"; renderProjectsList() }
function hideApp(){ $("#topbar").style.display="none"; $("#sidebar").style.display="none"; $("#viewport").style.display="none"; $("#projectsModal").style.display="none"; $("#usersModal").style.display="none" }

/* ===== Users admin ===== */
function renderUsers(){const list=$("#usersList");list.innerHTML="";const a=loadAuth();Object.entries(a.users).forEach(([u,rec])=>{const row=document.createElement("div");row.className="item";const nm=document.createElement("div");nm.className="name";nm.innerHTML=`<strong>${escapeHtml(u)}</strong> <span class="badge">${rec.role||"user"}</span>`;const acts=document.createElement("div");acts.className="actions";const mk=(t,cls,fn)=>{const b=document.createElement("button");b.textContent=t;b.className="btn "+(cls||"");b.onclick=fn;return b};const toggle=mk(rec.role==="admin"?"Rendre User":"Rendre Admin","",()=>{const A=loadAuth();if(rec.role==="admin"){const cnt=Object.values(A.users).filter(x=>x.role==="admin").length;if(cnt<=1){alert("Impossible de retirer le dernier admin.");return}A.users[u].role="user"}else{A.users[u].role="admin"};saveAuth(A);renderUsers()});const reset=mk("Reset PW","",async()=>{const np=prompt("Nouveau mot de passe pour "+u+":");if(!np)return;const A=loadAuth();const salt=randHex(16), hash=await sha256Hex(salt+np);A.users[u].salt=salt;A.users[u].hash=hash;saveAuth(A);alert("Mot de passe mis √† jour.")});const del=mk("Supprimer","danger",()=>{if(u===CURRENT_USER){alert("Tu ne peux pas supprimer l'utilisateur connect√©.");return}const A=loadAuth();const cnt=Object.values(A.users).filter(x=>x.role==="admin").length;if(A.users[u].role==="admin"&&cnt<=1){alert("Impossible de supprimer le dernier admin.");return}if(confirm("Supprimer '"+u+"' ?")){delete A.users[u];saveAuth(A);renderUsers()}});acts.append(toggle,reset,del);row.append(nm,acts);list.append(row)})}
$("#usersBtn").onclick=()=>{if(!isAdmin(CURRENT_USER))return;$("#usersModal").style.display="flex";renderUsers()};$("#closeUsersBtn").onclick=()=>{$("#usersModal").style.display="none"};
$("#addUserBtn").onclick=async()=>{const u=$("#nuUser").value.trim(), p=$("#nuPass").value, r=$("#nuRole").value;if(!u||!p){alert("Renseigne username et mot de passe.");return}const A=loadAuth();if(A.users[u]){alert("Ce username existe d√©j√†.");return}const salt=randHex(16), hash=await sha256Hex(salt+p);A.users[u]={salt,hash,role:r};saveAuth(A);$("#nuUser").value="";$("#nuPass").value="";$("#nuRole").value="user";renderUsers()};

/* ===== Projects ===== */
function projectsKey(user){return `milanote_projects_${user}`}function boardKey(user,projId){return `milanote_board_${user}_${projId}`}
function loadProjects(user){try{return JSON.parse(localStorage.getItem(projectsKey(user)))||{activeId:null,items:[]}}catch{return {activeId:null,items:[]}}}
function saveProjects(user,data){localStorage.setItem(projectsKey(user),JSON.stringify(data))}
function newProject(name="Nouveau projet"){const proj={id:idn(),name,createdAt:Date.now(),updatedAt:Date.now()};const p=loadProjects(CURRENT_USER);p.items.push(proj);p.activeId=proj.id;saveProjects(CURRENT_USER,p);CURRENT_PROJECT=proj;state=emptyState();saveBoard();applyState();return proj}
function getActiveProject(){const p=loadProjects(CURRENT_USER);return p.items.find(i=>i.id===p.activeId)||p.items[0]||null}
function setActiveProject(id){const p=loadProjects(CURRENT_USER);p.activeId=id;saveProjects(CURRENT_USER,p);CURRENT_PROJECT=p.items.find(i=>i.id===id)||null;loadBoard();applyState()}
function renameProject(id,name){const p=loadProjects(CURRENT_USER);const it=p.items.find(i=>i.id===id);if(!it)return;it.name=name;it.updatedAt=Date.now();saveProjects(CURRENT_USER,p);if(CURRENT_PROJECT&&CURRENT_PROJECT.id===id){CURRENT_PROJECT.name=name}renderProjectsList()}
function deleteProject(id){const p=loadProjects(CURRENT_USER);const idx=p.items.findIndex(i=>i.id===id);if(idx<0)return;p.items.splice(idx,1);localStorage.removeItem(boardKey(CURRENT_USER,id));if(p.activeId===id)p.activeId=p.items[0]?.id||null;saveProjects(CURRENT_USER,p);if(p.activeId){setActiveProject(p.activeId)}else{CURRENT_PROJECT=null;state=emptyState();applyState()}renderProjectsList()}
function duplicateProject(id){const src=JSON.parse(localStorage.getItem(boardKey(CURRENT_USER,id))||"null");if(!src){alert("Projet introuvable");return}const p=loadProjects(CURRENT_USER);const base=p.items.find(i=>i.id===id)?.name||"Projet";const copy={id:idn(),name:base+" (copie)",createdAt:Date.now(),updatedAt:Date.now()};p.items.push(copy);p.activeId=copy.id;saveProjects(CURRENT_USER,p);localStorage.setItem(boardKey(CURRENT_USER,copy.id),JSON.stringify(src));CURRENT_PROJECT=copy;loadBoard();applyState();renderProjectsList()}
function renderProjectsList(){const list=$("#projectsList");list.innerHTML="";const p=loadProjects(CURRENT_USER);if(p.items.length===0){const empty=document.createElement("div");empty.className="item";empty.innerHTML="<em>Aucun projet</em>";list.append(empty);return}p.items.forEach(it=>{const row=document.createElement("div");row.className="item";const active=p.activeId===it.id?" (actif)":"";const nm=document.createElement("div");nm.className="name";nm.innerHTML=`<strong>${escapeHtml(it.name)}</strong> <small>${active}</small><br><small>${new Date(it.updatedAt).toLocaleString()}</small>`;const acts=document.createElement("div");acts.className="actions";const mk=(t,fn)=>{const b=document.createElement("button");b.className="btn";b.textContent=t;b.onclick=fn;return b};acts.append(mk("Ouvrir",()=>setActiveProject(it.id)), mk("Renommer",()=>{const nv=prompt("Nouveau nom:",it.name);if(nv)renameProject(it.id,nv.trim())}), mk("Dupliquer",()=>duplicateProject(it.id)), mk("Supprimer",()=>{if(confirm("Supprimer ce projet ?"))deleteProject(it.id)}));row.append(nm,acts);list.append(row)})}
$("#projectsBtn").onclick=()=>{$("#projectsModal").style.display="flex";renderProjectsList()};$("#closeProjectsBtn").onclick=()=>{$("#projectsModal").style.display="none"};$("#createProjectBtn").onclick=()=>{const name=$("#newProjectName").value.trim()||"Nouveau projet";newProject(name);$("#newProjectName").value="";$("#projectsModal").style.display="none"}
async function firstOpenOrMigrate(){let proj=getActiveProject();if(!proj){const old=localStorage.getItem(OLD_SINGLE_KEY);if(old){const p=loadProjects(CURRENT_USER);const id=idn();const item={id,name:"Projet migr√©",createdAt:Date.now(),updatedAt:Date.now()};item.id=id;p.items.push(item);p.activeId=id;saveProjects(CURRENT_USER,p);localStorage.setItem(boardKey(CURRENT_USER,id),old);localStorage.removeItem(OLD_SINGLE_KEY);CURRENT_PROJECT=item}else{CURRENT_PROJECT=newProject("Mon premier projet")}}else{CURRENT_PROJECT=proj}loadBoard()}

/* ===== Board core ===== */
const canvas=$("#canvas"), wrap=$("#wrap"), wires=$("#wires"), ctx=$("#ctx"); const titleInput=$("#boardTitle"), search=$("#search"), connectBtn=$("#connectBtn");
let state=emptyState(); function emptyState(){return {title:"Projet D√©mo",zoom:1,pan:{x:600,y:400},readonly:false,cards:{},lines:{}}}
let drag=null, resize=null, panning=null, saveTimer=null, connectMode=false, connectSource=null, isSpace=false, lastHoverId=null, overColumnId=null, lastCreatedId=null;
function toCanvas(clientX,clientY){const r=wrap.getBoundingClientRect();return {x:(clientX-r.left-state.pan.x)/state.zoom,y:(clientY-r.top-state.pan.y)/state.zoom}}
function saveBoard(){if(!CURRENT_USER||!CURRENT_PROJECT)return;const p=loadProjects(CURRENT_USER);const it=p.items.find(i=>i.id===CURRENT_PROJECT.id);if(it){it.updatedAt=Date.now();saveProjects(CURRENT_USER,p)}clearTimeout(saveTimer);saveTimer=setTimeout(()=>{localStorage.setItem(boardKey(CURRENT_USER,CURRENT_PROJECT.id),JSON.stringify(state))},150)}
function loadBoard(){if(!CURRENT_USER||!CURRENT_PROJECT)return;const raw=localStorage.getItem(boardKey(CURRENT_USER,CURRENT_PROJECT.id));if(raw){try{state=JSON.parse(raw)}catch{state=emptyState()}}else{state=emptyState();seed();saveBoard()}applyState();applyTransform()}
function seed(){addCard("note",900,520,260,160,{text:"Double-clique pour √©diter\\nAlt+glisser: dupliquer"});addCard("doc",1180,520,320,220,{html:"<h2>Brief</h2><p>Objectifs, contraintes, livrables.</p>"});addCard("todo",1520,520,240,200,{items:[{t:"Collecter refs",c:false},{t:"Moodboard",c:true},{t:"Partager",c:false}]});addCard("swatch",900,720,230,120,{hex:"#3b82f6"});addCard("image",1160,760,280,220,{src:"https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=900&q=60",cap:"Inspiration"});addCard("link",1460,760,280,140,{url:"https://milanote.com",title:"Milanote",desc:"Visual boards"});addCard("column",1780,520,320,420,{title:"Id√©es",children:[]})}
function applyState(){titleInput.value=state.title;canvas.style.transform=`translate(${state.pan.x}px,${state.pan.y}px) scale(${state.zoom})`;document.body.classList.toggle("readonly",!!state.readonly);canvas.innerHTML="";const all=Object.values(state.cards);all.filter(c=>c.type==="column"&&!c.parent).forEach(renderCard);all.filter(c=>c.type!=="column"&&!c.parent).forEach(renderCard);all.filter(c=>c.parent).forEach(renderCard);renderLines()}
function renderCard(card){if(card.parent){const colEl=findEl(card.parent);const content=$(".content",colEl);const child=document.createElement("div");child.className="child";child.dataset.id=card.id;child.innerHTML=childInner(card);$(".child-actions .up",child)?.addEventListener("click",()=>moveChild(card.id,-1));$(".child-actions .down",child)?.addEventListener("click",()=>moveChild(card.id,1));$(".child-actions .detach",child)?.addEventListener("click",()=>detachFromColumn(card.id));content.append(child);return}
  const el=document.createElement("div");el.className=`card ${card.type}`+(card.locked?" locked":"");el.dataset.id=card.id;el.style.transform=cssPos(card.x,card.y);el.style.width=card.w+"px";el.style.height=card.h+"px";
  const head=document.createElement("div");head.className="card-header";const t=document.createElement("div");t.className="card-title";t.textContent=titleFor(card);const actions=document.createElement("div");actions.className="card-actions";
  if(!state.readonly){actions.append(btn("üîí","Lock/Unlock",()=>toggleLock(card.id),"edit-only"));actions.append(btn("‚ßâ","Dupliquer",()=>duplicateCard(card.id),"edit-only"));actions.append(btn("üí¨","Commentaires",()=>toggleComments(card.id)));actions.append(btn("üóëÔ∏è","Supprimer",()=>removeCard(card.id),"edit-only"))}head.append(t,actions);
  const content=document.createElement("div");content.className="content";mountContent(card,content);const rz=document.createElement("div");rz.className="resizer";el.append(head,content,rz);canvas.append(el);
  actions.addEventListener("pointerdown",e=>e.stopPropagation());actions.addEventListener("mousedown",e=>e.stopPropagation());actions.addEventListener("click",e=>e.stopPropagation());
  head.addEventListener("pointerdown",e=>{if(state.readonly||card.locked)return;if(e.button!==0)return;if(e.target.closest('.card-actions'))return;el.setPointerCapture(e.pointerId);drag={id:card.id,start:toCanvas(e.clientX,e.clientY),orig:{x:card.x,y:card.y},dup:e.altKey};if(drag.dup){duplicateCard(card.id,true);drag.id=lastCreatedId}});
  head.addEventListener("contextmenu",e=>{e.preventDefault();openCtx(card.id,e.clientX,e.clientY)});
  rz.addEventListener("pointerdown",e=>{if(state.readonly||card.locked)return;e.stopPropagation();el.setPointerCapture(e.pointerId);resize={id:card.id,start:toCanvas(e.clientX,e.clientY),orig:{w:card.w,h:card.h}}});
  if(matchesSearch(card)){el.style.outline="2px solid var(--accent)";el.style.outlineOffset="0"}
}
function btn(txt,title,fn,cls){const b=document.createElement("button");b.textContent=txt;b.title=title;b.onclick=(e)=>{e.stopPropagation();fn(e)};b.addEventListener("pointerdown",e=>e.stopPropagation());b.addEventListener("mousedown",e=>e.stopPropagation());if(cls)b.classList.add(cls);return b}
function titleFor(card){const m={column:card.content.title||"Colonne",note:"Note",doc:"Document",todo:"To-do",image:"Image",link:"Lien",swatch:"Couleur",table:"Tableau",map:"Carte"};return m[card.type]||card.type}
function childInner(card){const ttl=titleFor(card);if(card.type==="note"){const text=(card.content.text||"").split("\\n")[0]||"(vide)";return `<div class="child-actions"><button class="up">‚Üë</button><button class="down">‚Üì</button><button class="detach">‚Üó</button></div><strong>${ttl}</strong><div>${escapeHtml(text)}</div>`}
if(card.type==="link"){return `<div class="child-actions"><button class="up">‚Üë</button><button class="down">‚Üì</button><button class="detach">‚Üó</button></div><strong>${ttl}</strong><div class="link"><a href="${card.content.url||'#'}" target="_blank">${escapeHtml(card.content.title||card.content.url||"(lien)")}</a></div>`}
if(card.type==="swatch"){return `<div class="child-actions"><button class="up">‚Üë</button><button class="down">‚Üì</button><button class="detach">‚Üó</button></div><strong>${ttl}</strong><div class="swatch"><span class="chip" style="display:inline-block;width:18px;height:18px;border:1px solid var(--line);vertical-align:middle;background:${card.content.hex||'#888'}"></span> ${escapeHtml(card.content.hex||'')}</div>`}
return `<div class="child-actions"><button class="up">‚Üë</button><button class="down">‚Üì</button><button class="detach">‚Üó</button></div><strong>${ttl}</strong>`}
function mountContent(card,root){root.innerHTML="";const comments=document.createElement("div");comments.className="comments hidden";const list=document.createElement("div");const add=document.createElement("div");add.innerHTML=`<input placeholder="Ajouter un commentaire‚Ä¶" style="width:100%;padding:6px;border:1px solid var(--line);border-radius:8px"/>`;const inp=$("input",add);function renderComments(){list.innerHTML="";(card.content.comments||[]).forEach(c=>{const row=document.createElement("div");row.style.padding="6px 0";row.innerHTML=`<strong>${escapeHtml(c.author||"Moi")}</strong> ¬∑ <span style="color:var(--muted);font-size:12px">${new Date(c.ts||Date.now()).toLocaleString()}</span><div>${escapeHtml(c.text||"")}</div>`;list.append(row)})}inp.addEventListener("keydown",e=>{if(e.key==="Enter"&&inp.value.trim()){card.content.comments=card.content.comments||[];card.content.comments.push({text:inp.value.trim(),ts:Date.now(),author:CURRENT_USER||"Moi"});inp.value="";renderComments();saveBoard()}});comments.append(list,add);
  if(card.type==="note"){root.contentEditable=true;root.innerText=card.content.text||"";root.addEventListener("input",()=>{card.content.text=root.innerText;saveBoard()});root.append(comments)}
  if(card.type==="doc"){const tb=document.createElement("div");tb.className="toolbar";[["B","bold"],["I","italic"],["H1","h1"],["H2","h2"],["‚Ä¢","ul"],["1.","ol"]].forEach(([l,cmd])=>{const b=document.createElement("button");b.textContent=l;b.title=cmd;b.onclick=()=>applyDocCmd(cmd);tb.append(b)});const ed=document.createElement("div");ed.className="editor";ed.contentEditable=!state.readonly;ed.innerHTML=card.content.html||"<p>Commence √† √©crire‚Ä¶</p>";ed.addEventListener("input",()=>{card.content.html=ed.innerHTML;saveBoard()});root.append(tb,ed,comments)}
  if(card.type==="todo"){const ul=document.createElement("ul");(card.content.items||[]).forEach((it,idx)=>{const li=document.createElement("li");const cb=document.createElement("input");cb.type="checkbox";cb.checked=!!it.c;const tx=document.createElement("input");tx.type="text";tx.value=it.t||"";tx.style.flex="1";cb.onchange=()=>{it.c=cb.checked;saveBoard()};tx.oninput=()=>{it.t=tx.value;saveBoard()};const del=btn("‚úñ","Supprimer",()=>{card.content.items.splice(idx,1);mountContent(card,root);saveBoard()});li.append(cb,tx,del);ul.append(li)});const addI=btn("+ Item","Ajouter",()=>{card.content.items=card.content.items||[];card.content.items.push({t:"Nouvelle t√¢che",c:false});mountContent(card,root);saveBoard()});root.append(ul,addI,comments)}
  if(card.type==="image"){const img=document.createElement("img");img.src=card.content.src||"";const url=document.createElement("input");url.type="text";url.placeholder="URL image‚Ä¶";url.value=card.content.src||"";url.style.width="100%";url.onchange=()=>{card.content.src=url.value;img.src=url.value;saveBoard()};const file=document.createElement("input");file.type="file";file.accept="image/*";file.onchange=()=>{const f=file.files[0];if(!f)return;const u=URL.createObjectURL(f);img.src=u;card.content.src=u;saveBoard()};const cap=document.createElement("input");cap.type="text";cap.placeholder="L√©gende‚Ä¶";cap.value=card.content.cap||"";cap.style.width="100%";cap.oninput=()=>{card.content.cap=cap.value;saveBoard()};root.append(img,url,file,cap,comments)}
  if(card.type==="link"){const a=document.createElement("a");a.href=card.content.url||"#";a.target="_blank";a.textContent=card.content.title||card.content.url||"Lien";const meta=document.createElement("div");meta.className="meta";meta.textContent=card.content.desc||"";const ttl=input("Titre‚Ä¶",card.content.title||"",v=>{card.content.title=v;a.textContent=v||card.content.url||"Lien"});const url=input("https://‚Ä¶",card.content.url||"",v=>{card.content.url=v;a.href=v;if(!card.content.title)a.textContent=v});const dsc=input("Description‚Ä¶",card.content.desc||"",v=>{card.content.desc=v;meta.textContent=v});root.append(a,meta,ttl,url,dsc,comments)}
  if(card.type==="swatch"){const chip=document.createElement("span");chip.className="chip";chip.style.background=card.content.hex||"#888";const pick=document.createElement("input");pick.type="color";pick.value=normalizeHex(card.content.hex||"#3b82f6");const hex=input("#RRGGBB",card.content.hex||"#3b82f6",v=>{card.content.hex=v;chip.style.background=v;pick.value=normalizeHex(v)});pick.oninput=()=>{card.content.hex=pick.value;chip.style.background=pick.value;hex.querySelector("input").value=pick.value;saveBoard()};const row=document.createElement("div");row.className="swatch content";row.append(chip,pick,hex);root.append(row,comments)}
  if(card.type==="column"){const ti=input("Titre‚Ä¶",card.content.title||"",v=>{card.content.title=v;saveBoard();applyState()});const dz=document.createElement("div");dz.className="dropzone";dz.textContent="D√©pose une carte ici pour l'ajouter √† la colonne";const cont=document.createElement("div");cont.className="content";cont.append(ti,dz);root.append(cont,comments)}
  if(card.type==="table"){if(!card.content.cols){card.content.cols=["Nom","Valeur"];card.content.rows=[["A",10],["B",20]]}const controls=document.createElement("div");controls.style.display="flex";controls.style.gap="6px";controls.style.marginBottom="6px";const addCol=btn("+ Col","Ajouter colonne",()=>{card.content.cols.push("Col "+(card.content.cols.length+1));card.content.rows.forEach(r=>r.push(""));mountContent(card,root);saveBoard()});const addRow=btn("+ Ligne","Ajouter ligne",()=>{card.content.rows.push(Array(card.content.cols.length).fill(""));mountContent(card,root);saveBoard()});controls.append(addCol,addRow);const table=document.createElement("table");const thead=document.createElement("thead");const trh=document.createElement("tr");card.content.cols.forEach((c,i)=>{const th=document.createElement("th");const inp=document.createElement("input");inp.value=c;inp.oninput=()=>{card.content.cols[i]=inp.value;saveBoard()};th.append(inp);trh.append(th)});thead.append(trh);const tbody=document.createElement("tbody");card.content.rows.forEach((r,ri)=>{const tr=document.createElement("tr");r.forEach((v,ci)=>{const td=document.createElement("td");const inp=document.createElement("input");inp.value=v;inp.oninput=()=>{card.content.rows[ri][ci]=coerce(inp.value);saveBoard();updateFooter()};td.append(inp);tr.append(td)});tbody.append(tr)});const tfoot=document.createElement("tfoot");const trf=document.createElement("tr");function updateFooter(){trf.innerHTML="";card.content.cols.forEach((c,ci)=>{const td=document.createElement("td");const sum=card.content.rows.reduce((acc,row)=>acc+(typeof row[ci]==="number"?row[ci]:0),0);td.textContent=isFinite(sum)&&sum!==0?"Œ£ "+sum:"";trf.append(td)})}updateFooter();tfoot.append(trf);table.append(thead,tbody,tfoot);root.append(controls,table,comments)}
  if(card.type==="map"){const q=input("Adresse ou requ√™te (ex: Paris, France)‚Ä¶",card.content.q||"",v=>{card.content.q=v;setMap();saveBoard()});const frame=document.createElement("div");frame.className="map";const ifr=document.createElement("iframe");frame.append(ifr);function setMap(){const qv=encodeURIComponent(card.content.q||"Paris, France");ifr.src=`https://www.google.com/maps?q=${qv}&output=embed`}setMap();root.append(q,frame,comments)}
  function input(ph,value,oninput){const w=document.createElement("div");const i=document.createElement("input");i.placeholder=ph;i.value=value||"";i.style.width="100%";i.style.padding="6px";i.style.border="1px solid var(--line)";i.style.borderRadius="8px";i.oninput=()=>oninput(i.value);w.append(i);return w}
}
function applyDocCmd(cmd){const sel=window.getSelection();if(!sel||sel.rangeCount===0)return;let node=sel.getRangeAt(0).commonAncestorContainer;while(node&&node.nodeType!==1)node=node.parentNode;if(!node)return;const ed=node.closest(".editor");if(!ed)return;ed.focus();document.execCommand("styleWithCSS",false,true);if(cmd==="bold")document.execCommand("bold");if(cmd==="italic")document.execCommand("italic");if(cmd==="h1")document.execCommand("formatBlock",false,"h1");if(cmd==="h2")document.execCommand("formatBlock",false,"h2");if(cmd==="ul")document.execCommand("insertUnorderedList");if(cmd==="ol")document.execCommand("insertOrderedList")}
function findEl(cid){return $(`.card[data-id="${cid}"]`,canvas)}function isTopLevel(card){return !card.parent}
function rectCenter(c){return {x:c.x+c.w/2,y:c.y+c.h/2}}function edgePointFromTo(rect,toward){const cx=rect.x+rect.w/2,cy=rect.y+rect.h/2;let dx=toward.x-cx,dy=toward.y-cy;if(dx===0&&dy===0)return {x:cx,y:cy};const ex=rect.w/2,ey=rect.h/2;const scale=Math.max(Math.abs(dx)/ex,Math.abs(dy)/ey);return {x:cx+dx/scale,y:cy+dy/scale}}
function renderLines(){const w=$("#wires");w.innerHTML="";ensureMarker();for(const lid of Object.keys(state.lines)){const ln=state.lines[lid];const a=state.cards[ln.from], b=state.cards[ln.to];if(!a||!b||a.parent||b.parent)continue;const ca=rectCenter(a), cb=rectCenter(b);const pa=edgePointFromTo(a,cb), pb=edgePointFromTo(b,ca);const L=document.createElementNS("http://www.w3.org/2000/svg","line");L.setAttribute("x1",pa.x);L.setAttribute("y1",pa.y);L.setAttribute("x2",pb.x);L.setAttribute("y2",pb.y);L.setAttribute("stroke","#94a3b8");L.setAttribute("stroke-width","2");L.setAttribute("marker-end","url(#arrow)");w.append(L)}}
function ensureMarker(){const w=$("#wires");let defs=w.querySelector("defs");if(!defs){defs=document.createElementNS("http://www.w3.org/2000/svg","defs");w.append(defs)}let m=$("#arrow",defs);if(!m){m=document.createElementNS("http://www.w3.org/2000/svg","marker");m.setAttribute("id","arrow");m.setAttribute("orient","auto");m.setAttribute("markerWidth","8");m.setAttribute("markerHeight","8");m.setAttribute("refX","6");m.setAttribute("refY","3");const p=document.createElementNS("http://www.w3.org/2000/svg","path");p.setAttribute("d","M0,0 L6,3 L0,6 Z");p.setAttribute("fill","#94a3b8");m.append(p);defs.append(m)}}

function addCard(type,x,y,w=240,h=140,content={}){const c={id:idn(),type,x:Math.round(x/GRID)*GRID,y:Math.round(y/GRID)*GRID,w,h,content,locked:false,parent:null};state.cards[c.id]=c;lastCreatedId=c.id;return c.id}
function createCard(type,x,y){const idc=addCard(type,x,y);applyState();saveBoard();return idc}
function removeCard(cid){const card=state.cards[cid];if(!card)return;if(card.parent){const col=state.cards[card.parent];if(col) col.content.children=(col.content.children||[]).filter(i=>i!==cid)}for(const lid of Object.keys(state.lines)){const ln=state.lines[lid];if(ln.from===cid||ln.to===cid)delete state.lines[lid]}delete state.cards[cid];applyState();saveBoard()}
function duplicateCard(cid,silent=false){const src=state.cards[cid];if(!src)return;const clone=JSON.parse(JSON.stringify(src));clone.id=idn();clone.x+=24;clone.y+=24;clone.parent=null;state.cards[clone.id]=clone;lastCreatedId=clone.id;if(!silent)applyState();saveBoard()}
function toggleLock(cid){const c=state.cards[cid];if(!c)return;c.locked=!c.locked;applyState();saveBoard()}
function attachToColumn(cardId,columnId){const card=state.cards[cardId], col=state.cards[columnId];if(!card||!col||col.type!=="column")return;card.parent=columnId;col.content.children=col.content.children||[];if(!col.content.children.includes(cardId))col.content.children.push(cardId);applyState();saveBoard()}
function detachFromColumn(cardId){const card=state.cards[cardId];if(!card||!card.parent)return;const col=state.cards[card.parent];if(col){col.content.children=(col.content.children||[]).filter(i=>i!==cardId)}card.parent=null;card.x=Math.round(((col?.x||600)+(col?.w||300)+24)/GRID)*GRID;card.y=Math.round(((col?.y||300)+24)/GRID)*GRID;applyState();saveBoard()}
function moveChild(cardId,delta){const card=state.cards[cardId];const col=state.cards[card?.parent];if(!col)return;const arr=col.content.children;const i=arr.indexOf(cardId);if(i<0)return;const j=Math.max(0,Math.min(arr.length-1,i+delta));if(i===j)return;[arr[i],arr[j]]=[arr[j],arr[i]];applyState();saveBoard()}

$("#sidebar").addEventListener("dragstart",e=>{if(!e.target.classList.contains("tool"))return;e.dataTransfer.setData("text/plain",e.target.dataset.type)});
wrap.addEventListener("dragover",e=>{e.preventDefault()});
wrap.addEventListener("drop",e=>{e.preventDefault();const type=e.dataTransfer.getData("text/plain");const p=toCanvas(e.clientX,e.clientY);createCard(type,p.x,p.y)});

wrap.addEventListener("pointerdown",e=>{if(e.button===0&&(e.target===wrap||e.target===canvas)&&(isSpace||e.ctrlKey||e.metaKey)){const start={x:e.clientX,y:e.clientY};panning={start,orig:{...state.pan}}}});
window.addEventListener("pointermove",e=>{
  if(drag){const card=state.cards[drag.id];if(!card||card.locked)return;const p=toCanvas(e.clientX,e.clientY);card.x=Math.max(0,Math.min(8000-card.w,Math.round((drag.orig.x+(p.x-drag.start.x))/GRID)*GRID));card.y=Math.max(0,Math.min(8000-card.h,Math.round((drag.orig.y+(p.y-drag.start.y))/GRID)*GRID));findEl(card.id).style.transform=cssPos(card.x,card.y);overColumnId=detectOverColumn(e.clientX,e.clientY);renderLines()}
  if(resize){const card=state.cards[resize.id];if(!card||card.locked)return;const p=toCanvas(e.clientX,e.clientY);card.w=Math.max(160,Math.min(1000,Math.round((resize.orig.w+(p.x-resize.start.x))/GRID)*GRID));card.h=Math.max(96,Math.min(1000,Math.round((resize.orig.h+(p.y-resize.start.y))/GRID)*GRID));const el=findEl(card.id);el.style.width=card.w+"px";el.style.height=card.h+"px";renderLines()}
  if(panning){const dx=e.clientX-panning.start.x, dy=e.clientY-panning.start.y;state.pan.x=panning.orig.x+dx;state.pan.y=panning.orig.y+dy;applyTransform()}
});
window.addEventListener("pointerup",e=>{if(drag){if(overColumnId){attachToColumn(drag.id,overColumnId)}saveBoard()}drag=null;resize=null;panning=null;overColumnId=null});
canvas.addEventListener("mousemove",e=>{const el=e.target.closest(".card");lastHoverId=el?el.dataset.id:null});
function detectOverColumn(clientX,clientY){const el=document.elementFromPoint(clientX,clientY);const colEl=el?.closest(".card.column");return colEl?colEl.dataset.id:null}
function applyTransform(){const t=`translate(${state.pan.x}px,${state.pan.y}px) scale(${state.zoom})`;canvas.style.transform=t;wires.style.transform=t}

window.addEventListener("keydown",e=>{if(e.key===" ")isSpace=true;if((e.ctrlKey||e.metaKey)&&(e.key==="="||e.key==="+")){zoomBy(0.1);e.preventDefault()}if((e.ctrlKey||e.metaKey)&&e.key==="-"){zoomBy(-0.1);e.preventDefault()}if(e.key==="Delete"||e.key==="Backspace"){const el=document.activeElement;if(el&&(el.tagName==="INPUT"||el.isContentEditable))return;if(lastHoverId)removeCard(lastHoverId)}if(e.key==="/"){e.preventDefault();quickAdd()}if(e.key.toLowerCase()==="z"){fit()}if(e.key==="Escape"){hideCtx()}if(e.key.toLowerCase()==="c"&&(e.ctrlKey||e.metaKey)){toggleConnect()}});
window.addEventListener("keyup",e=>{if(e.key===" ")isSpace=false});
wrap.addEventListener("wheel",e=>{if(e.ctrlKey||e.metaKey){e.preventDefault();zoomBy(e.deltaY>0?-0.05:0.05,{x:e.clientX,y:e.clientY})}});
function zoomBy(delta,pivot=null){state.zoom=Math.max(0.25,Math.min(3,parseFloat((state.zoom+delta).toFixed(2))));if(pivot){const before=toCanvas(pivot.x,pivot.y);applyTransform();const after=toCanvas(pivot.x,pivot.y);state.pan.x+=(after.x-before.x)*state.zoom;state.pan.y+=(after.y-before.y)*state.zoom}applyTransform();saveBoard()}
$("#fitBtn").addEventListener("click",fit);
function fit(){const cards=Object.values(state.cards).filter(isTopLevel);if(cards.length===0){state.pan={x:600,y:400};state.zoom=1;applyTransform();return}const minX=Math.min(...cards.map(c=>c.x)), minY=Math.min(...cards.map(c=>c.y)), maxX=Math.max(...cards.map(c=>c.x+c.w)), maxY=Math.max(...cards.map(c=>c.y+c.h));const r=wrap.getBoundingClientRect(), pad=140;const sx=(r.width-pad)/(maxX-minX), sy=(r.height-pad)/(maxY-minY);state.zoom=Math.max(0.25,Math.min(2,Math.min(sx,sy)));state.pan.x=Math.round((r.width-(maxX-minX)*state.zoom)/2 - minX*state.zoom);state.pan.y=Math.round((r.height-(maxY-minY)*state.zoom)/2 - minY*state.zoom);applyTransform();saveBoard()}

let ctxTargetId=null;function openCtx(cid,x,y){ctxTargetId=cid;$("#ctx").style.display="block";$("#ctx").style.left=x+"px";$("#ctx").style.top=y+"px"}function hideCtx(){$("#ctx").style.display="none";ctxTargetId=null}
$("#ctx").addEventListener("click",e=>{const act=e.target.getAttribute("data-act");if(!ctxTargetId)return;if(act==="lock")toggleLock(ctxTargetId);if(act==="dup")duplicateCard(ctxTargetId);if(act==="del")removeCard(ctxTargetId);if(act==="comment")toggleComments(ctxTargetId);if(act==="movecol")moveToColumnPrompt(ctxTargetId);if(act==="detach")detachFromColumn(ctxTargetId);hideCtx()});
window.addEventListener("click",e=>{if(!$("#ctx").contains(e.target))hideCtx()});
function toggleComments(cid){const el=findEl(cid);if(!el)return;const panel=el.querySelector(".comments");if(!panel)return;panel.classList.toggle("hidden")}
function moveToColumnPrompt(cid){const cols=Object.values(state.cards).filter(c=>c.type==="column");if(cols.length===0){alert("Aucune colonne disponible.");return}const pick=prompt("ID de la colonne:",cols[0].id);if(!pick||!state.cards[pick]||state.cards[pick].type!=="column"){alert("ID invalide");return}attachToColumn(cid,pick)}
function toggleConnect(){connectMode=!connectMode;$("#connectBtn").classList.toggle("primary",connectMode);connectSource=null}
$("#connectBtn").addEventListener("click",toggleConnect);
canvas.addEventListener("click",e=>{if(!connectMode)return;const el=e.target.closest(".card");if(!el)return;const cid=el.dataset.id;const card=state.cards[cid];if(card.parent){alert("Connexion: cartes top-level uniquement.");return}if(!connectSource){connectSource=cid;el.style.outline="2px solid var(--accent)";setTimeout(()=>{const el2=findEl(cid);if(el2)el2.style.outline=""},500)}else{state.lines[idn()]={from:connectSource,to:cid};connectSource=null;renderLines();saveBoard()}});

$("#exportBtn").addEventListener("click",()=>{const data=JSON.stringify(state,null,2);const blob=new Blob([data],{type:"application/json"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=((CURRENT_PROJECT?.name)||"board")+".json";a.click();URL.revokeObjectURL(url)});
$("#importInput").addEventListener("change",e=>{const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=()=>{try{const obj=JSON.parse(reader.result);if(obj&&obj.cards){state=obj;applyState();saveBoard()}}catch{alert("JSON invalide")}};reader.readAsText(file)});
titleInput.addEventListener("input",()=>{state.title=titleInput.value;saveBoard()});
$("#search").addEventListener("input",()=>applyState());
function matchesSearch(card){const q=$("#search").value.trim().toLowerCase();if(!q)return false;const blob=JSON.stringify(card).toLowerCase();return blob.includes(q)}
function quickAdd(){const t=prompt("Type (note, doc, todo, image, link, swatch, column, table, map):","note");if(!t)return;const r=wrap.getBoundingClientRect();const cx=r.width/2, cy=r.height/2;const p=toCanvas(r.left+cx,r.top+cy);createCard(t.trim().toLowerCase(),p.x,p.y)}

(async function boot(){hideApp();await initAuthUI()})();
/* UI buttons */
$("#readonlyBtn").onclick=()=>{state.readonly=!state.readonly;$("#readonlyBtn").textContent="Read-only: "+(state.readonly?"ON":"OFF");applyState();saveBoard()}
$("#presentBtn").onclick=()=>{document.body.classList.toggle("present")}
$("#logoutBtn").onclick=logout;
</script>

<!-- === IndexedDB Patch: removes localStorage 5MB limit === -->
<script>
/* Directivenode IndexedDB storage override v1 (copy-paste ready)
   - Replaces saveBoard/loadBoard with IndexedDB backend
   - No Vercel config needed; works offline; survives big projects
*/
(function(){
  function openDB(){
    return new Promise((res, rej)=>{
      const r = indexedDB.open('directivenode-db', 1);
      r.onupgradeneeded = () => {
        const db = r.result;
        if (!db.objectStoreNames.contains('boards')) db.createObjectStore('boards');
        if (!db.objectStoreNames.contains('assets')) db.createObjectStore('assets');
      };
      r.onsuccess = () => res(r.result);
      r.onerror   = () => rej(r.error);
    });
  }
  async function idbGet(store, key){
    const db = await openDB();
    return new Promise((res)=>{
      const tx = db.transaction(store, 'readonly');
      const rq = tx.objectStore(store).get(key);
      rq.onsuccess = () => res(rq.result ?? null);
      rq.onerror   = () => res(null);
    });
  }
  async function idbSet(store, key, val){
    const db = await openDB();
    return new Promise((res, rej)=>{
      const tx = db.transaction(store, 'readwrite');
      tx.objectStore(store).put(val, key);
      tx.oncomplete = () => res();
      tx.onerror    = () => rej(tx.error);
    });
  }
  async function idbDel(store, key){
    const db = await openDB();
    return new Promise((res)=>{
      const tx = db.transaction(store, 'readwrite');
      tx.objectStore(store).delete(key);
      tx.oncomplete = () => res();
    });
  }

  // ensure persistence (avoid eviction by the browser)
  if (navigator.storage && navigator.storage.persist) {
    navigator.storage.persist();
  }

  // override key helper (keeps same format as original)
  window.boardKey = function(user, projId){ return `milanote_board_${user}_${projId}` }

  // override saveBoard to write to IndexedDB
  let __idbSaveTimer;
  window.saveBoard = function(){
    if(!window.CURRENT_USER || !window.CURRENT_PROJECT) return;
    try {
      // keep projects list logic untouched (likely localStorage)
      const p = loadProjects(window.CURRENT_USER);
      const it = p && p.items ? p.items.find(i => i.id === window.CURRENT_PROJECT.id) : null;
      if (it) { it.updatedAt = Date.now(); saveProjects(window.CURRENT_USER, p); }
    } catch(e){ /* ignore */ }

    clearTimeout(__idbSaveTimer);
    const key = boardKey(window.CURRENT_USER, window.CURRENT_PROJECT.id);
    const snapshot = JSON.stringify(window.state);
    __idbSaveTimer = setTimeout(async ()=>{
      try { await idbSet('boards', key, snapshot); }
      catch(e){ console.error('IndexedDB save failed:', e); }
    }, 120);
  };

  // override loadBoard to read from IndexedDB
  window.loadBoard = async function(){
    if(!window.CURRENT_USER || !window.CURRENT_PROJECT) return;
    const key = boardKey(window.CURRENT_USER, window.CURRENT_PROJECT.id);
    let raw = null;
    try { raw = await idbGet('boards', key); }
    catch(e){ console.warn('IndexedDB get failed:', e); }
    if (raw) {
      try { window.state = JSON.parse(raw); }
      catch(e){ window.state = emptyState(); }
    } else {
      window.state = emptyState();
      try { if (typeof seed === 'function') seed(); } catch(_){}
      try { await idbSet('boards', key, JSON.stringify(window.state)); } catch(e){}
    }
    try { applyState(); applyTransform(); } catch(e){ console.error(e); }
  };

  // optional helper if you clean up per-project
  window.__deleteBoardFromIDB = async function(projectId){
    try { await idbDel('boards', boardKey(window.CURRENT_USER, projectId)); } catch(e){}
  };
})();
</script>

</body>
</html>
