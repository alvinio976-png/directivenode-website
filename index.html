<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>directivenode</title>
<style>
/* ——— tout ton CSS existant ——— */
:root{--bg:#0f172a;--bg2:#0b1221;--panel:#0f172a;--panel2:#0b1221;--text:#e5e7eb;--muted:#9aa3b2;--accent:#3b82f6;--ok:#22c55e;--warn:#f59e0b;--danger:#ef4444;--card:#111827;--card2:#0f172a;--chip:#1f2937;--chip2:#0b1221;--soft:rgba(255,255,255,.06);--soft2:rgba(255,255,255,.03);--shadow:0 10px 30px rgba(0,0,0,.35)}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font:14px/1.45 ui-sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji"}
body{background:linear-gradient(180deg,#0b1221 0%,#0f172a 100%) fixed;color:var(--text)}
.container{display:flex;height:100%}
.sidebar{width:220px;background:linear-gradient(180deg,var(--panel) 0%,var(--panel2) 100%);border-right:1px solid rgba(255,255,255,.06);padding:14px;overflow:auto}
.sidebar h3{margin:10px 10px 16px;font-size:13px;font-weight:700;color:#cbd5e1;letter-spacing:.2px;text-transform:uppercase;opacity:.9}
.navbtn{display:flex;align-items:center;width:100%;gap:10px;padding:10px 12px;margin:6px 0;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,.06);color:#e5e7eb;text-decoration:none;cursor:pointer}
.navbtn:hover{background:rgba(255,255,255,.04)}
.navbtn .dot{width:10px;height:10px;border-radius:50%;background:#4b5563;box-shadow:0 0 0 2px rgba(255,255,255,.06) inset}
.navbtn span{flex:1}
.header{display:flex;align-items:center;gap:10px;padding:10px 16px;border-bottom:1px solid rgba(255,255,255,.06);background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.0))}
.header .left{display:flex;align-items:center;gap:10px}
.header .brand{font-weight:800;letter-spacing:.3px;color:#e5e7eb}
.header .chip{padding:6px 10px;border-radius:999px;background:rgba(59,130,246,.12);border:1px solid rgba(59,130,246,.45);color:#cfe0ff;font-weight:600}
.header .actions{margin-left:auto;display:flex;gap:10px}
.btn{height:34px;display:inline-flex;align-items:center;gap:8px;padding:0 12px;border-radius:10px;background:#1f2937;border:1px solid rgba(255,255,255,.06);color:#e5e7eb;cursor:pointer}
.btn.primary{background:#3b82f6;border-color:#4c8cff;color:white}
.btn.ghost{background:transparent}
.btn:disabled{opacity:.6;cursor:not-allowed}
.main{flex:1;display:flex;flex-direction:column;min-width:0}
.toolstrip{padding:8px 12px;display:flex;gap:8px;align-items:center;border-bottom:1px solid rgba(255,255,255,.06)}
.board{flex:1;position:relative;overflow:auto;background:
radial-gradient(1200px 600px at 80% -120px, rgba(59,130,246,.08), transparent 60%),
radial-gradient(800px 500px at -100px 100%, rgba(255,255,255,.06), transparent 50%)}
.canvas{min-height:100%;padding:28px}
.card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:14px;box-shadow:var(--shadow)}
/* ——— Projets modal ——— */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(3,7,18,.55);backdrop-filter:blur(6px);z-index:50}
.modal .panel{width:min(900px,92vw);background:linear-gradient(180deg,var(--panel) 0%,var(--panel2) 100%);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
.proj-header{display:flex;gap:10px;align-items:center;margin-bottom:12px}
.proj-input{flex:1;height:38px;padding:0 12px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);color:var(--text)}
.list{display:flex;flex-direction:column;gap:12px}
.item{display:flex;flex-direction:column;gap:8px;padding:12px;border-radius:12px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07)}
.item .row{display:flex;gap:10px;align-items:center}
.item .name{font-weight:800}
.item .meta{font-size:12px;color:#94a3b8}
.item .row .right{margin-left:auto;display:flex;gap:8px}
hr.sep{border:none;border-top:1px solid rgba(255,255,255,.06);margin:10px 0}
.muted{color:#94a3b8}
kbd{background:#111827;border:1px solid rgba(255,255,255,.08);border-radius:6px;padding:2px 6px;font-size:12px}
</style>
</head>
<body>

<div class="header">
  <div class="left">
    <div class="brand">directivenode</div>
    <div class="chip">Projet Démo</div>
  </div>
  <div class="actions">
    <button class="btn" onclick="openProjects()">Projets</button>
    <button class="btn primary" onclick="quickSave()">Enregistrer</button>
  </div>
</div>

<div class="container">
  <div class="sidebar">
    <h3>Outils</h3>
    <button class="navbtn" onclick="addCard('note')"><span>Note</span><div class="dot"></div></button>
    <button class="navbtn" onclick="addCard('document')"><span>Document</span><div class="dot"></div></button>
    <button class="navbtn" onclick="addCard('todo')"><span>To-do</span><div class="dot"></div></button>
    <button class="navbtn" onclick="addCard('image')"><span>Image</span><div class="dot"></div></button>
    <button class="navbtn" onclick="addCard('link')"><span>Lien</span><div class="dot"></div></button>
    <button class="navbtn" onclick="addCard('table')"><span>Tableau</span><div class="dot"></div></button>
  </div>

  <div class="main">
    <div class="toolstrip">
      <span class="muted">Astuce: <kbd>Ctrl/Cmd</kbd> + zoom • <kbd>?</kbd> Quick add • clic droit menu</span>
    </div>
    <div id="board" class="board">
      <div class="canvas" id="canvas">
        <!-- contenu du board rendu ici -->
      </div>
    </div>
  </div>
</div>

<!-- MODALE PROJETS -->
<div id="projectsModal" class="modal" aria-hidden="true">
  <div class="panel card">
    <div class="proj-header">
      <input id="newProjectName" class="proj-input" placeholder="Nom du nouveau projet">
      <button class="btn primary" onclick="createProject()">Créer</button>
      <button class="btn" onclick="closeProjects()">Fermer</button>
    </div>
    <div class="list" id="projectsList"></div>
  </div>
</div>

<script>
/* =========================
   STATE + UTIL
========================= */
const CURRENT_USER = 'ALVINIO';
let CURRENT_PROJECT = null;

function uid(){return Math.random().toString(36).slice(2)+Date.now().toString(36)}
function fmtDate(ts){try{const d=new Date(ts);return d.toLocaleString()}catch(_){return ''}}
function boardKey(user, pid){ return `board:${user}:${pid}` }
function projectsKey(user){ return `projects:${user}` }

/* =========================
   PROJECTS (LocalStorage)
========================= */
function loadProjects(user){
  const raw = localStorage.getItem(projectsKey(user));
  if (!raw){
    const id = uid();
    const initial = {activeId:id, items:[{id, name:'Nouveau projet', created:Date.now()}]};
    localStorage.setItem(projectsKey(user), JSON.stringify(initial));
    // board vide
    localStorage.setItem(boardKey(user,id), JSON.stringify({cards:[], meta:{}}));
    return initial;
  }
  try{return JSON.parse(raw)}catch(_){
    const fallback = {activeId:null, items:[]};
    localStorage.setItem(projectsKey(user), JSON.stringify(fallback));
    return fallback;
  }
}
function saveProjects(user, data){
  localStorage.setItem(projectsKey(user), JSON.stringify(data));
}

/* =========================
   IndexedDB helpers (optionnel)
========================= */
(function(){
  const DB_NAME = 'directivenode';
  const VERSION = 1;
  let dbPromise = null;
  function openDB(){
    if (dbPromise) return dbPromise;
    dbPromise = new Promise((resolve, reject)=>{
      const req = indexedDB.open(DB_NAME, VERSION);
      req.onupgradeneeded = e=>{
        const db = req.result;
        if (!db.objectStoreNames.contains('boards')){
          db.createObjectStore('boards');
        }
      };
      req.onsuccess = ()=>resolve(req.result);
      req.onerror = ()=>reject(req.error);
    });
    return dbPromise;
  }
  async function idbGet(store, key){
    const db = await openDB();
    return new Promise((resolve,reject)=>{
      const tx = db.transaction(store,'readonly');
      const st = tx.objectStore(store);
      const rq = st.get(key);
      rq.onsuccess = ()=>resolve(rq.result ?? null);
      rq.onerror = ()=>reject(rq.error);
    });
  }
  async function idbSet(store, key, val){
    const db = await openDB();
    return new Promise((resolve,reject)=>{
      const tx = db.transaction(store,'readwrite');
      const st = tx.objectStore(store);
      const rq = st.put(val, key);
      rq.onsuccess = ()=>resolve(true);
      rq.onerror = ()=>reject(rq.error);
    });
  }
  async function idbDel(store, key){
    const db = await openDB();
    return new Promise((resolve,reject)=>{
      const tx = db.transaction(store,'readwrite');
      const st = tx.objectStore(store);
      const rq = st.delete(key);
      rq.onsuccess = ()=>resolve(true);
      rq.onerror = ()=>reject(rq.error);
    });
  }
  // exposer (sert si d’autres scripts les utilisent)
  window.idbGet = idbGet;
  window.idbSet = idbSet;
  window.idbDel = idbDel;

  // surcharge des IO board (utilise IDB si possible, sinon fallback LS)
  window.saveBoard = async function(){
    const key = boardKey(CURRENT_USER, CURRENT_PROJECT?.id);
    if(!key) return;
    const data = JSON.stringify(window.__BOARD__ || {cards:[],meta:{}});
    try{ await idbSet('boards', key, data); }
    catch(_){ localStorage.setItem(key, data); }
  };
  window.loadBoard = async function(){
    const key = boardKey(CURRENT_USER, CURRENT_PROJECT?.id);
    if(!key) return;
    let raw = null;
    try{ raw = await idbGet('boards', key); }
    catch(_){ raw = localStorage.getItem(key); }
    if(!raw){
      // migration éventuelle depuis LS → IDB
      const legacy = localStorage.getItem(key);
      if (legacy){
        try{ await idbSet('boards', key, legacy); localStorage.removeItem(key); raw = legacy; }
        catch(_){ raw = legacy; }
      }
    }
    try{ window.__BOARD__ = raw ? JSON.parse(raw) : {cards:[],meta:{}}; }
    catch(_){ window.__BOARD__ = {cards:[],meta:{}}; }
    renderBoard();
  };
})();

/* =========================
   BOARD RENDER (très simple)
========================= */
window.__BOARD__ = {cards:[],meta:{}};

function addCard(type){
  const c = {id:uid(), type, text:type.toUpperCase(), created:Date.now()};
  __BOARD__.cards.push(c);
  renderBoard(); saveBoard();
}
function renderBoard(){
  const el = document.getElementById('canvas');
  if (!el) return;
  el.innerHTML = '';
  (__BOARD__.cards||[]).forEach(card=>{
    const div = document.createElement('div');
    div.className = 'card';
    div.style.margin = '10px 0';
    div.style.padding = '12px';
    div.innerHTML = `<div class="meta muted" style="font-size:12px">${card.type} • ${fmtDate(card.created)}</div>
                     <div style="font-weight:800;margin-top:6px">${(card.text||'').toString()}</div>`;
    el.appendChild(div);
  });
}

/* =========================
   PROJETS UI
========================= */
function openProjects(){
  buildProjectsList();
  document.getElementById('projectsModal').style.display='flex';
}
function closeProjects(){
  document.getElementById('projectsModal').style.display='none';
}
function buildProjectsList(){
  const list = document.getElementById('projectsList');
  const data = loadProjects(CURRENT_USER);
  list.innerHTML = '';
  data.items.forEach(it=>{
    const item = document.createElement('div');
    item.className = 'item';
    item.innerHTML = `
      <div class="row">
        <div class="name">${it.name} ${data.activeId===it.id ? '<span class="muted" style="font-weight:600">(actif)</span>':''}</div>
        <div class="right">
          <button class="btn" onclick="setActiveProject('${it.id}')">Ouvrir</button>
          <button class="btn" onclick="renameProjectPrompt('${it.id}')">Renommer</button>
          <button class="btn" onclick="duplicateProject('${it.id}')">Dupliquer</button>
          <button class="btn" onclick="deleteProject('${it.id}')">Supprimer</button>
        </div>
      </div>
      <div class="meta">${fmtDate(it.created)}</div>
    `;
    list.appendChild(item);
  });
}
function createProject(){
  const name = (document.getElementById('newProjectName').value || '').trim();
  if (!name) return;
  const data = loadProjects(CURRENT_USER);
  const id = uid();
  data.items.unshift({id, name, created:Date.now()});
  data.activeId = id;
  saveProjects(CURRENT_USER, data);
  localStorage.setItem(boardKey(CURRENT_USER,id), JSON.stringify({cards:[],meta:{}}));
  buildProjectsList();
}
function renameProjectPrompt(id){
  const data = loadProjects(CURRENT_USER);
  const it = data.items.find(x=>x.id===id);
  if(!it) return;
  const name = prompt('Nouveau nom du projet', it.name)||'';
  if(!name) return;
  it.name = name.trim();
  saveProjects(CURRENT_USER, data);
  buildProjectsList();
}
async function duplicateProject(id){
  const data = loadProjects(CURRENT_USER);
  const it = data.items.find(x=>x.id===id);
  if(!it) return;
  const newId = uid();
  const keyOld = boardKey(CURRENT_USER, id);
  const keyNew = boardKey(CURRENT_USER, newId);
  // lire source (IDB sinon LS)
  let src = null;
  try{ if (window.idbGet) src = await window.idbGet('boards', keyOld); }catch(_){}
  if(!src) src = localStorage.getItem(keyOld);
  if(!src) src = JSON.stringify({cards:[],meta:{}});
  try{ if (window.idbSet) await window.idbSet('boards', keyNew, src); else localStorage.setItem(keyNew, src); }
  catch(_){ localStorage.setItem(keyNew, src); }
  data.items.unshift({id:newId, name:it.name+' (copie)', created:Date.now()});
  saveProjects(CURRENT_USER, data);
  buildProjectsList();
}
async function deleteProject(id){
  const data = loadProjects(CURRENT_USER);
  const idx = data.items.findIndex(x=>x.id===id);
  if(idx<0) return;
  if(!confirm('Supprimer ce projet ?')) return;
  data.items.splice(idx,1);
  if(data.activeId===id) data.activeId = data.items[0]?.id || null;
  saveProjects(CURRENT_USER, data);
  // supprimer board
  const key = boardKey(CURRENT_USER, id);
  try{ if (window.idbDel) await window.idbDel('boards', key); else localStorage.removeItem(key); }
  catch(_){ localStorage.removeItem(key); }
  buildProjectsList();
}

/* ——— ancien setActiveProject (synchrone) éventuellement présent dans d’autres versions
function setActiveProject(id){
  const p = loadProjects(CURRENT_USER);
  p.activeId = id;
  saveProjects(CURRENT_USER, p);
  CURRENT_PROJECT = p.items.find(i=>i.id===id)||null;
  loadBoard(); applyState();
}
——— */

/* =========================
   APP INIT
========================= */
function applyState(){
  // point d’entrée UI pour rafraîchir si besoin
}
window.addEventListener('DOMContentLoaded', async ()=>{
  const p = loadProjects(CURRENT_USER);
  CURRENT_PROJECT = p.items.find(i=>i.id===p.activeId)||p.items[0]||null;
  await loadBoard();
});
function quickSave(){ saveBoard(); }
</script>

<!-- ===== DirectiveNode Open-Project Fix Patch (2025-08-24) ===== -->
<script>
(function(){
  const originalSetActive = window.setActiveProject;
  window.setActiveProject = async function(id){
    try{
      const p = (typeof loadProjects === "function") ? loadProjects(CURRENT_USER) : null;
      if (!p) throw new Error("loadProjects introuvable");
      p.activeId = id;
      if (typeof saveProjects === "function") saveProjects(CURRENT_USER, p);

      window.CURRENT_PROJECT = p.items ? (p.items.find(i => i.id === id) || null) : null;
      if (!window.CURRENT_PROJECT){
        alert("Projet introuvable"); 
        return;
      }

      try{
        const key = (typeof boardKey === "function") ? boardKey(CURRENT_USER, id) : null;
        if (key && window.idbGet && window.idbSet){
          const has = await window.idbGet('boards', key);
          if (has == null){
            const legacy = localStorage.getItem(key);
            if (legacy){
              await window.idbSet('boards', key, legacy);
              localStorage.removeItem(key);
            }
          }
        }
      }catch(e){}

      if (typeof window.loadBoard === "function"){
        await window.loadBoard();
      }
      const modal = document.getElementById('projectsModal');
      if (modal) modal.style.display = 'none';
      if (typeof window.applyState === "function") window.applyState();
    }catch(err){
      console.error("setActiveProject (override) error:", err);
      if (typeof originalSetActive === "function"){
        try{ originalSetActive(id); }catch(_){}
      }else{
        alert("Impossible d’ouvrir ce projet (voir console).");
      }
    }
  };

  try{
    if (typeof idbGet === "function" && !('idbGet' in window)) window.idbGet = idbGet;
    if (typeof idbSet === "function" && !('idbSet' in window)) window.idbSet = idbSet;
    if (typeof idbDel === "function" && !('idbDel' in window)) window.idbDel = idbDel;
  }catch(e){}
})();
</script>
<!-- ===== /DirectiveNode Fix Patch ===== -->

</body>
</html>
